#!/bin/sh

prefix="/opt"
PATH=${prefix}/bin:${prefix}/sbin:/sbin:/bin:/usr/sbin:/usr/bin


start() {
	# Start dnscrypt services, reading DNS servers from file /opt/etc/dnscrypt.conf
	if [ -f /opt/etc/dnscrypt.conf ]; then
		n=1
		port=64001
		while read -r server || [[ -n "$server" ]]; do
			if [ ! -z "$server" ] ; then
				ln -sf /opt/sbin/dnscrypt-proxy /tmp/dnscrypt-proxy$n
				/tmp/dnscrypt-proxy$n --local-address=127.0.0.1:$port --daemonize -R $server
				n=$(($n+1))
				port=$(($port+1))
			fi
		done < /opt/etc/dnscrypt.conf
	fi
}

stop() {
	# Stop dnscrypt-proxy services
	if [ -f /opt/etc/dnscrypt.conf ]; then
		n=1
		while read -r server || [[ -n "$server" ]]; do
			if [ ! -z "$server" ] ; then
				killall -9 dnscrypt-proxy$n
				rm -f /tmp/dnscrypt-proxy$n
				n=$(($n+1))
			fi
		done < /opt/etc/dnscrypt.conf
	fi
}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	*)
		echo "Usage: $0 (start|stop)"
		exit 1
		;;
esac

exit 0
